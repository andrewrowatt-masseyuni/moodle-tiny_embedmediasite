{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TODO describe module ui\n *\n * @module     tiny_embedmediasite/ui\n * @copyright  2026 Andrew Rowatt <A.J.Rowatt@massey.ac.nz>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport EmbedMediasiteModal from './modal';\nimport Templates from 'core/templates';\nimport {exception as displayException} from 'core/notification';\nimport {getMyMediasitePresentations} from './repository';\n\n/**\n * Handle action\n *\n * @param {TinyMCE} editor\n */\nexport const handleAction = async(editor) => {\n    displayDialogue(editor);\n};\n\n/**\n * Display modal\n *\n * @param  {TinyMCE} editor\n */\nconst displayDialogue = async(editor) => {\n    let page = 1; // Track which \"page\" of data to load\n\n    // Get first page of presentations. The template (mostly) handles the case of zero presentations.\n    let presentations = await getMyMediasitePresentations(page)\n            .catch((error) => displayException(error));\n\n    // Show modal with buttons.\n    const modal = await EmbedMediasiteModal.create({\n        templateContext: {presentations: presentations},\n        large: true,\n        removeOnClose: true,\n    });\n\n    await modal.show();\n\n    const contentContainer = document.getElementById('tiny_embedmediasite_content-container');\n    contentContainer.addEventListener('click', async event => {\n        const target = event.target;\n        if (target && target.classList.contains('tiny-embedmediasite-insert-button')) {\n            const {html} = await Templates.renderForPromise(\n                'tiny_embedmediasite/_embedlink', {\n                    source: target.dataset.source,\n                    title: target.dataset.title\n                });\n            editor.insertContent(html);\n            modal.destroy();\n        }\n    });\n\n    const loadingIndicator = document.getElementById('tiny_embedmediasite_loading');\n    const noMoreContentIndicator = document.getElementById('tiny_embedmediasite_no_more_content');\n\n    /**\n     * Load the second and subsequent pages of content.\n     *\n     * @param {*} pageNumber\n     * @return {number} Number of presentations loaded\n     */\n    async function loadMoreContent(pageNumber) {\n        // Get a page of presentations.\n        const presentations = await getMyMediasitePresentations(pageNumber)\n            .catch((error) => displayException(error));\n\n        if (!presentations?.length) {\n            // Short circuit if no presentations.\n            return 0;\n        }\n\n        // Render and append the new presentations.\n        const {html, js} = await Templates.renderForPromise(\n            'tiny_embedmediasite/_presentations',\n            {presentations: presentations}\n        );\n        Templates.appendNodeContents('#tiny_embedmediasite_content-container', html, js);\n        return presentations.length;\n    }\n\n    // Set up the Intersection Observer\n    const observer = new IntersectionObserver(async entries => {\n        // Check if the loading indicator is visible\n        if (entries[0].isIntersecting) {\n            // Stop observing temporarily to prevent multiple calls while loading\n            observer.unobserve(loadingIndicator);\n\n            page++;\n            if (await loadMoreContent(page)) {\n                // Re-observe the indicator after fetch completes\n                observer.observe(loadingIndicator);\n            } else {\n                // No more data to load; hide the loading indicator\n                loadingIndicator.style.display = 'none';\n                noMoreContentIndicator.style.display = 'block';\n            }\n        }\n    }, {\n        root: null, // Observe the viewport\n        threshold: 1.0, // Trigger when 100% of the indicator is visible\n        rootMargin: '0px'\n    });\n\n    // Start observing the loading indicator element\n    observer.observe(loadingIndicator);\n};\n"],"names":["async","displayDialogue","editor","page","presentations","catch","error","modal","EmbedMediasiteModal","create","templateContext","large","removeOnClose","show","document","getElementById","addEventListener","target","event","classList","contains","html","Templates","renderForPromise","source","dataset","title","insertContent","destroy","loadingIndicator","noMoreContentIndicator","observer","IntersectionObserver","entries","isIntersecting","unobserve","pageNumber","length","js","appendNodeContents","loadMoreContent","observe","style","display","root","threshold","rootMargin"],"mappings":";;;;;;;oMAiC4BA,MAAAA,SACxBC,gBAAgBC,eAQdD,gBAAkBD,MAAAA,aAChBG,KAAO,EAGPC,oBAAsB,2CAA4BD,MAC7CE,OAAOC,QAAU,2BAAiBA,eAGrCC,YAAcC,eAAoBC,OAAO,CAC3CC,gBAAiB,CAACN,cAAeA,eACjCO,OAAO,EACPC,eAAe,UAGbL,MAAMM,OAEaC,SAASC,eAAe,yCAChCC,iBAAiB,SAAShB,MAAAA,cACjCiB,OAASC,MAAMD,UACjBA,QAAUA,OAAOE,UAAUC,SAAS,qCAAsC,OACpEC,KAACA,YAAcC,mBAAUC,iBAC3B,iCAAkC,CAC9BC,OAAQP,OAAOQ,QAAQD,OACvBE,MAAOT,OAAOQ,QAAQC,QAE9BxB,OAAOyB,cAAcN,MACrBd,MAAMqB,oBAIRC,iBAAmBf,SAASC,eAAe,+BAC3Ce,uBAAyBhB,SAASC,eAAe,6CA4BjDgB,SAAW,IAAIC,sBAAqBhC,MAAAA,UAElCiC,QAAQ,GAAGC,iBAEXH,SAASI,UAAUN,kBAEnB1B,4BA1BuBiC,kBAErBhC,oBAAsB,2CAA4BgC,YACnD/B,OAAOC,QAAU,2BAAiBA,YAElCF,MAAAA,gBAAAA,cAAeiC,cAET,QAILhB,KAACA,KAADiB,GAAOA,UAAYhB,mBAAUC,iBAC/B,qCACA,CAACnB,cAAeA,0CAEVmC,mBAAmB,yCAA0ClB,KAAMiB,IACtElC,cAAciC,OAWPG,CAAgBrC,MAEtB4B,SAASU,QAAQZ,mBAGjBA,iBAAiBa,MAAMC,QAAU,OACjCb,uBAAuBY,MAAMC,QAAU,YAGhD,CACCC,KAAM,KACNC,UAAW,EACXC,WAAY,QAIhBf,SAASU,QAAQZ"}